#!/bin/bash
set -e

# 1. Setup EMSDK
git clone https://github.com/emscripten-core/emsdk.git
cd emsdk
./emsdk install latest
./emsdk activate latest
source ./emsdk_env.sh
cd ..

# 2. Download QEMU (optional: v10.1.2)
wget https://download.qemu.org/qemu-10.1.2.tar.xz
tar xvJf qemu-10.1.2.tar.xz
mv qemu-10.1.2 qemu-src

# Or clone latest git version:
# git clone --depth=1 https://gitlab.com/qemu-project/qemu.git qemu-src

# 3. Create build directory
mkdir -p build-wasm
cd build-wasm

# 4. Configure Meson for WebAssembly
meson setup . ../qemu-src \
  --cross-file ../.github/workflows/emscripten.cross \
  -Dtargets=x86_64-softmmu \
  -Dtcg-interpreter=true \
  -Dglib=disabled \
  -Dgtk=disabled \
  -Dsdl=disabled \
  -Dxen=disabled \
  -Dkvm=disabled \
  -Dvnc=disabled \
  -Dopengl=disabled \
  -Ddocs=false \
  -Dtools=false \
  -Duser=false

# 5. Build
ninja -C .

# 6. Copy output to dist/
mkdir -p ../dist
cp qemu-system-x86_64.js ../dist/ 2>/dev/null || true
cp qemu-system-x86_64.wasm ../dist/ 2>/dev/null || true

echo "âœ… Build complete. Files in dist/:"
ls -lh ../dist
